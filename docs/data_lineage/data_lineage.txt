**Data Lineage for `data_models`**

- **Purpose**: Map each model to its upstream sources and key column mappings. Include notable transformations (deduplication, computed columns, filters).

**Staging Models**
- `data_models/staging/stg_p2p_transfers.sql`:
  - **Upstream source**: `raw_transaction.raw_p2p_transfers`
  - **Key column mappings**: `rp.transfer_id` -> `transfer_id`, `rp.sender_id` -> `sender_user_id`, `rp.receiver_id` -> `receiver_user_id`, `rp.token_id` -> `token_id`, `rp.amount` -> `transfer_quantity`, `rp.status` -> `transfer_status`, `rp.transfer_created_time` -> `transfer_created_utc_datetime`, `rp.transfer_updated_time` -> `transfer_updated_utc_datetime`
  - **Notable logic**: Uses `QUALIFY ROW_NUMBER() OVER (PARTITION BY transfer_id ORDER BY transfer_created_time DESC) = 1` to dedupe and keep latest per `transfer_id`.

- `data_models/staging/stg_trades.sql`:
  - **Upstream source**: `raw_transaction.raw_trades`
  - **Key column mappings**: `rt.trade_id` -> `trade_id`, `rt.user_id` -> `user_id`, `rt.token_id` -> `token_id`, `rt.side` -> `trade_side`, `rt.price_usd` -> `trade_price_usd`, `rt.quantity` -> `trade_quantity`, `rt.status` -> `trade_status`, `rt.trade_created_time` -> `trade_created_utc_datetime`, `rt.trade_updated_time` -> `trade_updated_utc_datetime`
  - **Notable logic**: Deduplication with `QUALIFY ROW_NUMBER() OVER (PARTITION BY trade_id ORDER BY trade_created_time DESC) = 1`.

- `data_models/staging/stg_users.sql`:
  - **Upstream source**: `raw_kyc.raw_users`
  - **Key column mappings**: `ru.user_id` -> `user_id`, `ru.region` -> `user_region`, `ru.signup_date` -> `user_signup_date`
  - **Notable logic**: Deduplicate with `QUALIFY ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY signup_date DESC) = 1`.

- `data_models/staging/stg_tokens.sql`:
  - **Upstream source**: `raw_config.raw_tokens`
  - **Key column mappings**: `rt.token_id` -> `token_id`, `rt.token_name` -> `token_name`, `rt.category` -> `token_category`
  - **Notable logic**: Deduplicate on `token_id`.

**Core Models**
- `data_models/core/dim_users.sql`:
  - **Upstream source**: `staging.stg_users`
  - **Columns produced**: `user_id`, `user_region`, `user_signup_date` (passed-through from staging)

- `data_models/core/dim_tokens.sql`:
  - **Upstream source**: `staging.stg_tokens`
  - **Columns produced**: `token_id`, `token_name`, `token_category`

- `data_models/core/fact_p2p_transfers.sql`:
  - **Upstream source**: `staging.stg_p2p_transfers`
  - **Columns produced**: `transfer_id`, `sender_user_id`, `receiver_user_id`, `token_id`, `transfer_quantity`, `transfer_status`, `transfer_created_utc_datetime`, `transfer_updated_utc_datetime`

- `data_models/core/fact_trades.sql`:
  - **Upstream source**: `staging.stg_trades`
  - **Columns produced**: `trade_id`, `user_id`, `token_id`, `trade_side`, `trade_price_usd`, `trade_quantity`, `trade_status`, `trade_created_utc_datetime`, `trade_updated_utc_datetime`
  - **Derived column**: `trade_notional_usd` = `trade_price_usd * trade_quantity` (cast to numeric(38,8)).

- `data_models/core/fact_events.sql`:
  - **Upstream sources**: `staging.stg_p2p_transfers` (as P2P events) and `staging.stg_trades` (as TRADE events)
  - **Union logic**: `SELECT ... FROM stg_p2p_transfers UNION ALL SELECT ... FROM stg_trades` to produce a consolidated events table
  - **Columns produced**: `event_id`, `user_id`, `token_id`, `event_status`, `event_category` (`'P2P'` or `'TRADE'`), `event_utc_datetime`

**Mart Models**
- `data_models/mart/monthly_event_count.sql`:
  - **Upstream source**: `core.fact_events`
  - **Logic**: Filter `event_status IN ('SUCCESS', 'FILLED')`, group by `date_trunc('month', event_utc_datetime)` and `token_id`.
  - **Columns produced**: `event_utc_month`, `token_id`, `event_count`, `p2p_event_count`, `trade_event_count`.

**Overall lineage/DAG (high level)**
- Raw sources (`raw_transaction.*`, `raw_kyc.*`, `raw_config.*`)
  -> `staging` (`stg_p2p_transfers`, `stg_trades`, `stg_users`, `stg_tokens`) [dedupe / casts / rename]
  -> `core` (`dim_users`, `dim_tokens`, `fact_p2p_transfers`, `fact_trades`, `fact_events`) [simple selects, derived `trade_notional_usd`, union to events]
  -> `mart` (`monthly_event_count`) [aggregation and filter on `event_status`]

**Notes & data-quality considerations**
- Staging models apply `ROW_NUMBER()` deduplication; lineage should note that the latest record per natural key is used.
- `fact_events` is a union of P2P and TRADE event sources; any downstream counts inherit event_category.
- `mart.monthly_event_count` filters by `event_status` = `('SUCCESS','FILLED')` â€” so upstream events with other statuses are excluded from mart totals.

If you want, I can also:
- generate a DOT/Graphviz DAG from this mapping;
- add column-level lineage arrows (source column -> target column) as a CSV for import into lineage tools.
